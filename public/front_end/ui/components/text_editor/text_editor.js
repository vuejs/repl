import*as e from"../../../core/common/common.js";import*as t from"../../../core/i18n/i18n.js";import*as o from"../../../services/window_bounds/window_bounds.js";import*as n from"../../../third_party/codemirror.next/codemirror.next.js";import*as i from"../code_highlighter/code_highlighter.js";import*as r from"../../../core/sdk/sdk.js";import*as s from"../../../models/formatter/formatter.js";import*as a from"../../../models/javascript_metadata/javascript_metadata.js";import*as c from"../../legacy/legacy.js";import*as l from"../../lit-html/lit-html.js";import*as d from"../helpers/helpers.js";const u=n.EditorView.theme({"&.cm-editor":{color:"color: var(--color-text-primary)",cursor:"auto","&.cm-focused":{outline:"none"}},".cm-scroller":{lineHeight:"1.2em",fontFamily:"var(--source-code-font-family)",fontSize:"var(--source-code-font-size)"},".cm-panels":{backgroundColor:"var(--color-background-elevation-1)"},".cm-selectionMatch":{backgroundColor:"var(--color-selection-highlight)"},".cm-cursor":{borderLeft:"1px solid var(--color-background-inverted)"},"&.cm-readonly .cm-cursor":{display:"none"},".cm-cursor-secondary":{borderLeft:"1px solid var(--color-secondary-cursor)"},".cm-selectionBackground":{background:"var(--color-editor-selection-selection)"},"&.cm-focused .cm-selectionBackground":{background:"var(--color-editor-selection)"},".cm-gutters":{borderRight:"1px solid var(--color-details-hairline)",whiteSpace:"nowrap",backgroundColor:"var(--color-background)"},".cm-lineNumbers":{overflow:"visible",minWidth:"40px"},".cm-lineNumbers .cm-gutterElement":{color:"var(--color-line-number)",padding:"0 3px 0 9px"},".cm-matchingBracket, .cm-nonmatchingBracket":{background:"transparent",borderBottom:"none"},"&:focus-within .cm-matchingBracket":{color:"inherit",backgroundColor:"var(--color-matching-bracket-background)",borderBottom:"1px solid var(--color-matching-bracket-underline)"},"&:focus-within .cm-nonmatchingBracket":{backgroundColor:"var(--color-nonmatching-bracket-background)",borderBottom:"1px solid var(--color-nonmatching-bracket-underline)"},".cm-trailingWhitespace":{backgroundColor:"var(--color-trailing-whitespace)"},".cm-highlightedTab":{display:"inline-block",position:"relative","&:before":{content:'""',borderBottom:"1px solid var(--color-text-secondary)",position:"absolute",left:"5%",bottom:"50%",width:"90%",pointerEvents:"none"}},".cm-highlightedSpaces:before":{color:"var(--color-text-secondary)",content:"attr(data-display)",position:"absolute",pointerEvents:"none"},".cm-placeholder":{color:"var(--color-text-secondary)"},".cm-completionHint":{color:"var(--color-text-secondary)"},".cm-tooltip":{boxShadow:"var(--drop-shadow)",backgroundColor:"var(--color-background-elevation-1)"},".cm-argumentHints":{pointerEvents:"none",padding:"0 4px",whiteSpace:"nowrap",lineHeight:"20px",marginBottom:"4px",width:"fit-content"},".cm-tooltip.cm-tooltip-autocomplete > ul":{backgroundColor:"var(--color-background)",minWidth:"16em","& > li.cm-secondaryCompletion":{display:"flex",backgroundColor:"var(--color-background-elevation-1)",justifyContent:"space-between","&::before":{content:'">"',fontWeight:"bold",color:"var(--color-primary-variant)",marginRight:"5px"}},"& > li:hover":{backgroundColor:"var(--item-hover-color)"},"& > li[aria-selected]":{backgroundColor:"var(--color-selected-option-background)","&, &.cm-secondaryCompletion::before":{color:"var(--color-selected-option)"}}},".cm-completionMatchedText":{textDecoration:"none",fontWeight:"bold"},".cm-highlightedLine":{animation:"cm-fading-highlight 2s 0s"},"@keyframes cm-fading-highlight":{from:{backgroundColor:"var(--color-highlighted-line)"},to:{backgroundColor:"transparent"}}}),m={codeEditor:"Code editor"},p=t.i18n.registerUIStrings("ui/components/text_editor/config.ts",m),h=t.i18n.getLocalizedString.bind(void 0,p),f=[],g=n.Facet.define();class b{settingName;getExtension;compartment=new n.Compartment;constructor(e,t){this.settingName=e,this.getExtension=t}settingValue(){return e.Settings.Settings.instance().moduleSetting(this.settingName).get()}instance(){return[this.compartment.of(this.getExtension(this.settingValue())),g.of(this)]}sync(e,t){const o=this.compartment.get(e),n=this.getExtension(t);return o===n?null:this.compartment.reconfigure(n)}static bool(e,t,o=f){return new b(e,(e=>e?t:o))}static none=[]}const v=b.bool("textEditorTabMovesFocus",[],n.keymap.of([{key:"Tab",run:e=>!!e.state.doc.length&&n.indentMore(e),shift:e=>!!e.state.doc.length&&n.indentLess(e)}])),y=n.autocompletion({icons:!1,optionClass:e=>"secondary"===e.type?"cm-secondaryCompletion":""}),w=b.bool("textEditorAutocompletion",y),E=b.bool("textEditorBracketMatching",n.bracketMatching()),S=b.bool("textEditorCodeFolding",[n.foldGutter(),n.keymap.of(n.foldKeymap)]);function x(t){const o=Object.create(null);let n=0;for(let e=t.iterLines(1,Math.min(t.lines+1,1e3));!e.next().done;){let t=/^\s*/.exec(e.value)[0];if(t.length!==e.value.length&&t.length&&"*"!==e.value[t.length]){if("\t"===t[0])t="\t";else if(/[^ ]/.test(t))continue;n++,o[t]=(o[t]||0)+1}}const i=.05*n;return Object.entries(o).reduce(((e,[t,o])=>o<i||e&&e.length<t.length?e:t),null)??e.Settings.Settings.instance().moduleSetting("textEditorIndent").get()}const C=n.Prec.highest(n.indentUnit.compute([],(e=>x(e.doc)))),k=b.bool("textEditorAutoDetectIndent",C);function M(e){return n.ViewPlugin.define((t=>({decorations:e.createDeco(t),update(t){this.decorations=e.updateDeco(t,this.decorations)}})),{decorations:e=>e.decorations})}const T=new Map;const j=M(new n.MatchDecorator({regexp:/\t| +/g,decoration:e=>function(e){const t=T.get(e);if(t)return t;const o=n.Decoration.mark({attributes:"\t"===e?{class:"cm-highlightedTab"}:{class:"cm-highlightedSpaces","data-display":"·".repeat(e.length)}});return T.set(e,o),o}(e[0]),boundary:/\S/})),D=M(new n.MatchDecorator({regexp:/\s+$/g,decoration:n.Decoration.mark({class:"cm-trailingWhitespace"}),boundary:/\S/})),L=new b("showWhitespacesInEditor",(e=>"all"===e?j:"trailing"===e?D:f)),O=b.bool("allowScrollPastEof",n.scrollPastEnd()),B=Object.create(null);const P=new b("textEditorIndent",(function(e){let t=B[e];return t||(t=B[e]=n.indentUnit.of(e)),t})),N=b.bool("domWordWrap",n.EditorView.lineWrapping);function I(e){return/\r\n/.test(e)&&!/(^|[^\r])\n/.test(e)?n.EditorState.lineSeparator.of("\r\n"):[]}const W=n.keymap.of([{key:"Tab",run:n.acceptCompletion},{key:"Ctrl-m",run:n.cursorMatchingBracket,shift:n.selectMatchingBracket},{key:"Mod-/",run:n.toggleComment},{key:"Mod-d",run:n.selectNextOccurrence},{key:"Alt-ArrowLeft",mac:"Ctrl-ArrowLeft",run:n.cursorSubwordBackward,shift:n.selectSubwordBackward},{key:"Alt-ArrowRight",mac:"Ctrl-ArrowRight",run:n.cursorSubwordForward,shift:n.selectSubwordForward},...n.standardKeymap,...n.historyKeymap]);function z(){const t=e.Settings.Settings.instance().moduleSetting("uiTheme").get();return"systemPreferred"===t?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"===t}const _=n.EditorView.theme({},{dark:!0});function A(){return[u,z()?_:[]]}let F=null;function H(){return F||(F=o.WindowBoundsService.WindowBoundsServiceImpl.instance().getDevToolsBoundingElement()),F.getBoundingClientRect()}function R(e){return[A(),n.highlightSpecialChars(),n.history(),n.drawSelection(),n.EditorState.allowMultipleSelections.of(!0),n.indentOnInput(),i.CodeHighlighter.highlightStyle,W,v.instance(),E.instance(),P.instance(),n.Prec.lowest(n.EditorView.contentAttributes.of({"aria-label":h(m.codeEditor)})),I(e),y,n.tooltips({parent:$(),tooltipSpace:H})]}const V=[n.closeBrackets(),n.keymap.of(n.closeBracketsKeymap)];let U=null;function $(){if(!U){const e=n.EditorState.create({extensions:[u,z()?_:[],i.CodeHighlighter.highlightStyle,n.showTooltip.of({pos:0,create:()=>({dom:document.createElement("div")})})]}).facet(n.EditorView.styleModule),t=document.body.appendChild(document.createElement("div"));t.className="editor-tooltip-host",U=t.attachShadow({mode:"open"}),n.StyleModule.mount(U,e)}return U}class G extends n.WidgetType{text;constructor(e){super(),this.text=e}eq(e){return this.text===e.text}toDOM(){const e=document.createElement("span");return e.className="cm-completionHint",e.textContent=this.text,e}}const J=n.ViewPlugin.fromClass(class{decorations=n.Decoration.none;currentHint=null;update(e){const t=this.currentHint=this.topCompletion(e.state);this.decorations=t?n.Decoration.set([n.Decoration.widget({widget:new G(t),side:1}).range(e.state.selection.main.head)]):n.Decoration.none}topCompletion(e){const t=n.selectedCompletion(e);if(!t)return null;let{label:o,apply:i}=t;if("string"==typeof i&&(o=i,i=void 0),i||o.length>100||o.indexOf("\n")>-1||"secondary"===t.type)return null;const r=e.selection.main.head,s=e.doc.lineAt(r);if(r!==s.to)return null;const a=/#?[\w$]+$/.exec(s.text);return a&&!o.startsWith(a[0])?null:o.slice(a?a[0].length:0)}},{decorations:e=>e.decorations});var K=Object.freeze({__proto__:null,dynamicSetting:g,DynamicSetting:b,tabMovesFocus:v,autocompletion:y,sourcesAutocompletion:w,bracketMatching:E,codeFolding:S,guessIndent:x,autoDetectIndent:k,showWhitespace:L,allowScrollPastEof:O,indentUnit:P,domWordWrap:N,theme:A,baseConfiguration:R,closeBrackets:V,showCompletionHint:J,contentIncludingHint:function(e){const t=e.plugin(J);let o=e.state.doc.toString();if(t&&t.currentHint){const{head:n}=e.state.selection.main;o=o.slice(0,n)+t.currentHint+o.slice(n)}return o}});class q{completions;seen;constructor(e=[],t=new Set){this.completions=e,this.seen=t}add(e){this.seen.has(e.label)||(this.seen.add(e.label),this.completions.push(e))}copy(){return new q(this.completions.slice(),new Set(this.seen))}}const Q=["async","await","break","case","catch","class","const","continue","debugger","default","delete","do","else","export","extends","false","finally","for","function","if","import","in","instanceof","let","new","null","of","return","static","super","switch","this","throw","true","try","typeof","var","void","while","with","yield"],X=["clear","copy","debug","dir","dirxml","getEventListeners","inspect","keys","monitor","monitorEvents","profile","profileEnd","queryObjects","table","undebug","unmonitor","unmonitorEvents","values"],Y=["$","$$","$x","$0","$_"],Z=new q;for(const e of Q)Z.add({label:e,type:"keyword"});for(const e of X)Z.add({label:e,type:"function"});for(const e of Y)Z.add({label:e,type:"variable"});const ee=new Set(["TemplateString","LineComment","BlockComment","TypeDefinition","VariableDefinition","PropertyDefinition","TypeName"]);function te(e,t,o){let n=e.resolveInner(t,-1);const i=n.parent;if(ee.has(n.name))return null;if("PropertyName"===n.name||"PrivatePropertyName"===n.name)return"MemberExpression"!==i?.name?null:{type:1,from:n.from,relatedNode:i};if("VariableName"===n.name||!n.firstChild&&n.to-n.from<20&&!/[^a-z]/.test(o.sliceString(n.from,n.to)))return{type:0,from:n.from};if("String"===n.name){const e=n.parent;return"MemberExpression"===e?.name&&"["===e.childBefore(n.from)?.name?{type:2,from:n.from,relatedNode:e}:null}if(n=n.enterUnfinishedNodesBefore(t),n.to===t&&"MemberExpression"===n.parent?.name&&(n=n.parent),"MemberExpression"===n.name){const e=n.childBefore(Math.min(t,n.to));if("["===e?.name)return{type:2,relatedNode:n};if("."===e?.name||"?."===e?.name)return{type:1,relatedNode:n}}return{type:0}}async function oe(e){const t=te(n.syntaxTree(e.state),e.pos,e.state.doc);if(!t||void 0===t.from&&!e.explicit&&0===t.type)return null;let o;if(0===t.type){const[e,t]=await Promise.all([le(),de()]);if(e.completions.length){o=e;for(const e of t.completions)o.add(e)}else o=t}else{if(1!==t.type&&2!==t.type)return null;{const n=t.relatedNode.getChild("Expression");let i;if(2===t.type&&(i=void 0===t.from?"'":e.state.sliceDoc(t.from,t.from+1)),!n)return null;o=await async function(e,t,o=!1){const n=ae.instance();if(!t){const t=n.get(e);if(t)return t}const i=ne();if(!i)return new q;const r=ce(e,i,t,o);t||n.set(e,r);return r}(e.state.sliceDoc(n.from,n.to),i,"]"===e.state.sliceDoc(e.pos,e.pos+1))}}return{from:t.from??e.pos,options:o.completions,span:/^#?[\w\P{ASCII}]*/u}}function ne(){return c.Context.Context.instance().flavor(r.RuntimeModel.ExecutionContext)}async function ie(e,t,o){const n=await e.evaluate({expression:t,objectGroup:o,includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);return"error"in n||n.exceptionDetails||!n.object?null:n.object}const re=new Map([["string","String"],["number","Number"],["boolean","Boolean"],["bigint","BigInt"]]);let se=null;class ae{#e=new Map;constructor(){const e=()=>this.#e.clear();r.ConsoleModel.ConsoleModel.instance().addEventListener(r.ConsoleModel.Events.CommandEvaluated,e),c.Context.Context.instance().addFlavorChangeListener(r.RuntimeModel.ExecutionContext,e),r.TargetManager.TargetManager.instance().addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.DebuggerResumed,e),r.TargetManager.TargetManager.instance().addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.DebuggerPaused,e)}get(e){return this.#e.get(e)}set(e,t){this.#e.set(e,t),setTimeout((()=>{this.#e.get(e)===t&&this.#e.delete(e)}),3e4)}static instance(){return se||(se=new ae),se}}async function ce(e,t,o,n=!1){const i=new q;if(!t)return i;let r=await ie(t,e,"completion");if(!r)return i;for(;"object"===r.type&&"proxy"===r.subtype;){const e=(await r.getOwnProperties(!1)).internalProperties?.find((e=>"[[Target]]"===e.name))?.value;if(!e)break;r=e}const s="array"===r.subtype?"Array":"typedarray"===r.subtype?"Uint8Array":re.get(r.type);s&&(r=await ie(t,s+".prototype","completion"));const a="globalThis"===e?"function":"method",c="globalThis"===e?"variable":"property";if(r&&("object"===r.type||"function"===r.type)){const t=await r.getAllProperties(!1,!1),s="function"===r.type;for(const r of t.properties||[])if(!(r.symbol||s&&("arguments"===r.name||"caller"===r.name)||r.private&&"this"!==e)){const e=o?o+r.name+o:r.name,t={label:e,type:"function"===r.value?.type?a:c};o&&!n&&(t.apply=e+"]"),r.isOwn||(t.boost=-80),i.add(t)}}return t.runtimeModel.releaseObjectGroup("completion"),i}async function le(){const e=new q,t=ne()?.debuggerModel.selectedCallFrame();if(!t)return e;const o=await Promise.all(t.scopeChain().map((e=>e.object().getAllProperties(!1,!1))));for(const t of o)for(const o of t.properties||[])e.add({label:o.name,type:"function"===o.value?.type?"function":"variable"});return e}async function de(){const e=ae.instance(),t=e.get("");if(t)return t;const o=ne();if(!o)return Z;const n=Z.copy(),i=ce("globalThis",o).then((e=>o.globalLexicalScopeNames().then((t=>{for(const t of e.completions)n.add(t);for(const e of t||[])n.add({label:e,type:"variable"});return n}))));return e.set("",i),i}async function ue(e,t){const o=n.syntaxTree(e).resolveInner(t).enterUnfinishedNodesBefore(t);if("ArgList"!==o.name)return null;const i=o.parent?.getChild("Expression");if(!i)return null;const r=await async function(e,t){const o=ne();if(!o)return null;try{const n=t.sliceString(e.from,e.to),i=await ie(o,n,"argumentsHint");return i&&"function"===i.type?me(i,(async()=>{const n=e.firstChild;return n&&"MemberExpression"===e.name?ie(o,t.sliceString(n.from,n.to),"argumentsHint"):null}),n):null}finally{o.runtimeModel.releaseObjectGroup("argumentsHint")}}(i,e.doc);if(!r)return null;let s=0;for(let e=t;;){const t=o.childBefore(e);if(!t)break;t.type.is("Expression")&&s++,e=t.from}return()=>function(e,t){const o=document.createElement("div");o.className="cm-argumentHints";for(const n of e){const e=document.createElement("span");for(let o=0;o<n.length;o++){if(o===t||o<t&&n[o].startsWith("...")){e.appendChild(document.createElement("b")).appendChild(document.createTextNode(n[o]))}else e.appendChild(document.createTextNode(n[o]));o<n.length-1&&e.appendChild(document.createTextNode(", "))}const i=o.appendChild(document.createElement("div"));i.className="source-code",i.appendChild(document.createTextNode("ƒ(")),i.appendChild(e),i.appendChild(document.createTextNode(")"))}return{dom:o}}(r,s)}async function me(e,t,o){const n=e.description;if(!n)return null;if(!n.endsWith("{ [native code] }"))return[await s.FormatterWorkerPool.formatterWorkerPool().argumentsList(n)];if("function () { [native code] }"===n){const t=await async function(e){const{internalProperties:t}=await e.getOwnProperties(!1);if(!t)return null;const o=t.find((e=>"[[TargetFunction]]"===e.name))?.value,n=t.find((e=>"[[BoundArgs]]"===e.name))?.value,i=t.find((e=>"[[BoundThis]]"===e.name))?.value;if(!i||!o||!n)return null;const s=await me(o,(()=>Promise.resolve(i))),a=r.RemoteObject.RemoteObject.arrayLength(n);if(!s)return null;return s.map((e=>{const t=e.findIndex((e=>e.startsWith("...")));return t>-1&&t<a?e.slice(t):e.slice(a)}))}(e);if(t)return t}const i=a.JavaScriptMetadata.JavaScriptMetadataImpl.instance(),c=/^function ([^(]*)\(/.exec(n),l=c&&c[1]||o;if(!l)return null;const d=i.signaturesForNativeFunction(l);if(d)return d;const u=await t();if(!u)return null;const m=u.className;if(m){const e=i.signaturesForInstanceMethod(l,m);if(e)return e}if(u.description&&"function"===u.type&&u.description.endsWith("{ [native code] }")){const e=/^function ([^(]*)\(/.exec(u.description);if(e){const t=e[1],o=i.signaturesForStaticMethod(l,t);if(o)return o}}for(const e of await async function(e){if("number"===e.type)return["Number","Object"];if("string"===e.type)return["String","Object"];if("symbol"===e.type)return["Symbol","Object"];if("bigint"===e.type)return["BigInt","Object"];if("boolean"===e.type)return["Boolean","Object"];if("undefined"===e.type||"null"===e.subtype)return[];return await e.callFunctionJSON((function(){const e=[];for(let t=this;t;t=Object.getPrototypeOf(t))"object"==typeof t&&t.constructor&&t.constructor.name&&(e[e.length]=t.constructor.name);return e}),[])}(u)){const t=i.signaturesForInstanceMethod(l,e);if(t)return t}return null}var pe=Object.freeze({__proto__:null,completion:function(){return n.javascript.javascriptLanguage.data.of({autocomplete:oe})},completeInContext:async function(e,t,o=!1){const i=n.EditorState.create({doc:e,selection:{anchor:e.length},extensions:n.javascript.javascriptLanguage}),r=await oe(new n.CompletionContext(i,e.length,o));return r?r.options.filter((e=>e.label.startsWith(t))).map((e=>({text:e.label,priority:100+(e.boost||0),isSecondary:"secondary"===e.type}))):[]},getQueryType:te,javascriptCompletionSource:oe,isExpressionComplete:function(e){for(const t=n.syntaxTree(e).cursor();t.next();)if(t.type.isError)return!1;return!0},argumentHints:function(){return function(e){const t=n.StateEffect.define();return[n.StateField.define({create:()=>null,update(e,o){o.selection&&(e=null),e&&!o.changes.empty&&(e={pos:o.changes.mapPos(e.pos),create:e.create,above:!0});for(const n of o.effects)n.is(t)&&(e={pos:o.state.selection.main.from,create:n.value,above:!0});return e},provide:e=>n.showTooltip.from(e)}),n.ViewPlugin.fromClass(class{pending=-1;updateID=0;update(e){this.updateID++,e.transactions.some((e=>e.selection))&&e.state.selection.main.empty&&this.scheduleUpdate(e.view)}scheduleUpdate(e){this.pending>-1&&clearTimeout(this.pending),this.pending=setTimeout((()=>this.startUpdate(e)),50)}startUpdate(o){this.pending=-1;const{main:n}=o.state.selection;if(n.empty){const{updateID:i}=this;e(o.state,n.from).then((e=>{this.updateID!==i?this.pending<0&&this.scheduleUpdate(o):e&&o.dispatch({effects:t.of(e)})}))}}})]}(ue)}});function he(e,{lineNumber:t,columnNumber:o}){const n=e.line(Math.max(1,Math.min(e.lines,t+1)));return Math.max(n.from,Math.min(n.to,n.from+o))}function fe(e,t){t=Math.max(0,Math.min(t,e.length));const o=e.lineAt(t);return{lineNumber:o.number-1,columnNumber:t-o.from}}var ge=Object.freeze({__proto__:null,toOffset:he,toLineColumn:fe});class be extends HTMLElement{static litTagName=l.literal`devtools-text-editor`;#t=this.attachShadow({mode:"open"});#o=void 0;#n=b.none;#i=[];#r;#s={left:0,top:0};#a=-1;#c=()=>{this.#a<0&&(this.#a=window.setTimeout((()=>{this.#a=-1,this.#o&&n.repositionTooltips(this.#o)}),50))};#l=new ResizeObserver(this.#c);constructor(e){super(),this.#r=e,this.#t.adoptedStyleSheets=[i.Style.default]}createEditor(){return this.#o=new n.EditorView({state:this.state,parent:this.#t,root:this.#t,dispatch:e=>{this.editor.update([e]),e.reconfigured&&this.ensureSettingListeners()}}),this.#o.scrollDOM.scrollTop=this.#s.top,this.#o.scrollDOM.scrollLeft=this.#s.left,this.#o.scrollDOM.addEventListener("scroll",(e=>{this.#s.left=e.target.scrollLeft,this.#s.top=e.target.scrollTop})),this.ensureSettingListeners(),this.startObservingResize(),this.#o}get editor(){return this.#o||this.createEditor()}dispatch(e){return this.editor.dispatch(e)}get state(){return this.#o?this.#o.state:(this.#r||(this.#r=n.EditorState.create({extensions:R("")})),this.#r)}set state(e){this.#o?this.#o.setState(e):this.#r=e}connectedCallback(){this.#o||this.createEditor()}disconnectedCallback(){this.#o&&(this.#r=this.#o.state,this.#l.disconnect(),window.removeEventListener("resize",this.#c),this.#o.destroy(),this.#o=void 0,this.ensureSettingListeners())}focus(){this.#o&&this.#o.focus()}ensureSettingListeners(){const t=this.#o?this.#o.state.facet(g):b.none;if(t===this.#n)return;this.#n=t;for(const[e,t]of this.#i)e.removeChangeListener(t);this.#i=[];const o=e.Settings.Settings.instance();for(const e of t){const t=({data:t})=>{const o=e.sync(this.state,t);o&&this.#o&&this.#o.dispatch({effects:o})},n=o.moduleSetting(e.settingName);n.addChangeListener(t),this.#i.push([n,t])}}startObservingResize(){const e=o.WindowBoundsService.WindowBoundsServiceImpl.instance().getDevToolsBoundingElement();e&&this.#l.observe(e),window.addEventListener("resize",this.#c)}revealPosition(e,t=!0){const o=this.#o;if(!o)return;const i=o.state.doc.lineAt(e.main.head),r=[];t&&r.push(o.state.field(we,!1)?ve.of(i.from):n.StateEffect.appendConfig.of(we.init((()=>ye(i.from)))));const s=o.scrollDOM.getBoundingClientRect(),a=o.coordsAtPos(e.main.head);if((!a||a.top<s.top||a.bottom>s.bottom)&&r.push(n.EditorView.centerOn.of(e.main)),o.dispatch({selection:e,effects:r,userEvent:"select.reveal"}),t){const{id:e}=o.state.field(we);setTimeout((()=>{o.state.field(we).id===e&&o.dispatch({effects:ve.of(null)})}),2e3)}}createSelection(e,t){const{doc:o}=this.state,i=he(o,e);return n.EditorSelection.single(t?he(o,t):i,i)}toLineColumn(e){return fe(this.state.doc,e)}toOffset(e){return he(this.state.doc,e)}}d.CustomElements.defineComponent("devtools-text-editor",be);const ve=n.StateEffect.define({map:(e,t)=>null===e?null:t.mapPos(e)});function ye(e){return{deco:n.Decoration.set([n.Decoration.line({attributes:{class:"cm-highlightedLine"}}).range(e)]),id:Math.floor(1048575*Math.random())}}const we=n.StateField.define({create:()=>({deco:n.Decoration.none,id:0}),update(e,t){!t.changes.empty&&e.deco.size&&(e={deco:e.deco.map(t.changes),id:e.id});for(const o of t.effects)o.is(ve)&&(e=null===o.value?{deco:n.Decoration.none,id:0}:ye(o.value));return e},provide:e=>n.EditorView.decorations.from(e,(e=>e.deco))});var Ee=Object.freeze({__proto__:null,TextEditor:be});export{K as Config,pe as JavaScript,ge as Position,Ee as TextEditor};
